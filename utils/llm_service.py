import logging
import json
from typing import List, Dict, Optional, Any
from groq import AsyncGroq
from config import GROQ_API_KEYS, GROQ_MODEL

logger = logging.getLogger(__name__)


class GroqService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Groq API —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π (round-robin)
    """

    def __init__(self, api_keys: List[str], model: str = "llama-3.3-70b-versatile"):
        self.api_keys = api_keys
        self.model = model
        self.current_key_index = 0

        # –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        self.clients = []
        for idx, key in enumerate(api_keys, 1):
            try:
                client = AsyncGroq(api_key=key)
                self.clients.append(client)
                logger.debug(f"Groq –∫–ª–∏–µ–Ω—Ç {idx}/{len(api_keys)} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Groq –∫–ª–∏–µ–Ω—Ç–∞ {idx}: {e}")

        if not self.clients:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ Groq –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á–∏.")

        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω GroqService —Å {len(self.clients)}/{len(api_keys)} –∫–ª—é—á–∞–º–∏, –º–æ–¥–µ–ª—å: {model}")

    def _get_next_client(self) -> AsyncGroq:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É round-robin"""
        client = self.clients[self.current_key_index]
        self.current_key_index = (self.current_key_index + 1) % len(self.clients)
        return client

    async def get_completion(
        self,
        messages: List[Dict[str, str]],
        temperature: float = 0.7,
        max_tokens: int = 500
    ) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç LLM

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{"role": "user"/"assistant"/"system", "content": "—Ç–µ–∫—Å—Ç"}]
            temperature: –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (0.0 - 1.0)
            max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞

        Returns:
            –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        """
        for attempt in range(len(self.clients)):
            try:
                client = self._get_next_client()

                response = await client.chat.completions.create(
                    model=self.model,
                    messages=messages,
                    temperature=temperature,
                    max_tokens=max_tokens
                )

                answer = response.choices[0].message.content
                logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Groq (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1})")
                return answer

            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}): {e}")
                if attempt == len(self.clients) - 1:
                    logger.error("–í—Å–µ –∫–ª—é—á–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
                    return None
                continue

        return None

    async def classify_message_relevance(self, user_message: str, conversation_context: list = None) -> Dict[str, any]:
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫—É —Ä–∞–±–æ—Ç—ã

        Args:
            user_message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_context: –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            {
                "is_relevant": bool,  # –°–≤—è–∑–∞–Ω–æ –ª–∏ —Å –ø–æ–∏—Å–∫–æ–º —Ä–∞–±–æ—Ç—ã, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –±–æ—Ç–∞
                "confidence": float,  # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (0.0 - 1.0)
                "category": str       # "job_search", "bot_help", "calculator", "offtopic", "agreement"
            }
        """

        system_prompt = """–¢—ã - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –±–æ—Ç–∞ –ø–æ –ø–æ–∏—Å–∫—É —Ä–∞–±–æ—Ç—ã.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

1. "job_search" - –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, –≤–∞–∫–∞–Ω—Å–∏–∏, –∫–∞—Ä—å–µ—Ä–∞, —Ä–µ–∑—é–º–µ, —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è
2. "bot_help" - –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ –±–æ—Ç–∞, –ø–æ–º–æ—â—å, –∫–æ–º–∞–Ω–¥—ã
3. "calculator" - –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
4. "agreement" - —Å–æ–≥–ª–∞—Å–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ("–¥–∞", "–¥–∞–≤–∞–π", "—Ö–æ—Ä–æ—à–æ", "–æ–∫" –∏ —Ç.–¥.)
5. "offtopic" - –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ (–æ–±—â–µ–Ω–∏–µ –æ –∂–∏–∑–Ω–∏, —à—É—Ç–∫–∏, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å —Ä–∞–±–æ—Ç–æ–π)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ü–†–û–§–ï–°–°–ò–ô –ß–ï–†–ï–ó –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨:
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –î–ï–ô–°–¢–í–ò–Ø/–î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ (—á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç –î–ï–õ–ê–¢–¨),
—ç—Ç–æ –í–°–ï–ì–î–ê –∫–∞—Ç–µ–≥–æ—Ä–∏—è "job_search", –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã!

–ü–†–ò–ú–ï–†–´ "job_search" (—á–µ—Ä–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏):
- "–•–æ—á—É –ø–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ" ‚Üí job_search (—Å—Ç–æ–ª—è—Ä/–ø–ª–æ—Ç–Ω–∏–∫)
- "–•–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–µ—Ä–µ–≤–æ–º" ‚Üí job_search (—Å—Ç–æ–ª—è—Ä/–º–µ–±–µ–ª—å—â–∏–∫)
- "–•–æ—á—É –≥–æ—Ç–æ–≤–∏—Ç—å –µ–¥—É" ‚Üí job_search (–ø–æ–≤–∞—Ä)
- "–•–æ—á—É –≥–æ—Ç–æ–≤–∏—Ç—å" ‚Üí job_search (–ø–æ–≤–∞—Ä)
- "–•–æ—á—É —á–∏–Ω–∏—Ç—å –º–∞—à–∏–Ω—ã" ‚Üí job_search (–∞–≤—Ç–æ–º–µ—Ö–∞–Ω–∏–∫)
- "–•–æ—á—É —É–±–∏—Ä–∞—Ç—å" ‚Üí job_search (—É–±–æ—Ä—â–∏–∫)
- "–•–æ—á—É –≤–æ–¥–∏—Ç—å –º–∞—à–∏–Ω—É" ‚Üí job_search (–≤–æ–¥–∏—Ç–µ–ª—å)
- "–•–æ—á—É —É—á–∏—Ç—å –¥–µ—Ç–µ–π" ‚Üí job_search (—É—á–∏—Ç–µ–ª—å)
- "–•–æ—á—É –ø—Ä–æ–¥–∞–≤–∞—Ç—å" ‚Üí job_search (–ø—Ä–æ–¥–∞–≤–µ—Ü)
- "–•–æ—á—É —Å—Ç—Ä–∏—á—å" ‚Üí job_search (–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä)
- "–•–æ—á—É —Å—Ç—Ä–æ–∏—Ç—å" ‚Üí job_search (—Å—Ç—Ä–æ–∏—Ç–µ–ª—å)
- "–•–æ—á—É –ª–µ—á–∏—Ç—å" ‚Üí job_search (–≤—Ä–∞—á/–º–µ–¥—Å–µ—Å—Ç—Ä–∞)
- "–•–æ—á—É –¥–µ–ª–∞—Ç—å —Å–∞–π—Ç—ã" ‚Üí job_search (–≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)
- "—Ä–∞–±–æ—Ç–∞ –≤ –ø–∏—Ü—Ü–µ—Ä–∏–∏" ‚Üí job_search
- "—Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø–∏—Ü—Ü–µ—Ä–∏–∏" ‚Üí job_search
- "Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" ‚Üí job_search
- "–Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É" ‚Üí job_search

–ü–†–ò–ú–ï–†–´ "agreement" (—Å–æ–≥–ª–∞—Å–∏–µ/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ):
- "–¥–∞" ‚Üí agreement
- "–¥–∞–≤–∞–π" ‚Üí agreement
- "—Ö–æ—Ä–æ—à–æ" ‚Üí agreement
- "–æ–∫" ‚Üí agreement
- "—Å–æ–≥–ª–∞—Å–µ–Ω" ‚Üí agreement
- "–∫–æ–Ω–µ—á–Ω–æ" ‚Üí agreement
- "–ø–æ–∏—â–µ–º" ‚Üí agreement

–ü–†–ò–ú–ï–†–´ "offtopic":
- "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?" ‚Üí offtopic
- "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?" ‚Üí offtopic
- "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç" ‚Üí offtopic
- "–ß—Ç–æ –¥—É–º–∞–µ—à—å –æ –∂–∏–∑–Ω–∏?" ‚Üí offtopic

–í–ê–ñ–ù–û: –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω!

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{"is_relevant": true/false, "confidence": 0.0-1.0, "category": "–∫–∞—Ç–µ–≥–æ—Ä–∏—è"}

is_relevant = true –¥–ª—è: job_search, bot_help, calculator, agreement
is_relevant = false –¥–ª—è: offtopic"""

        messages = [
            {"role": "system", "content": system_prompt}
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
        if conversation_context:
            messages.extend(conversation_context[-4:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages.append({"role": "user", "content": user_message})

        try:
            response = await self.get_completion(messages, temperature=0.3, max_tokens=100)
            if not response:
                return {"is_relevant": True, "confidence": 0.5, "category": "unknown"}

            # –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.startswith('```'):
                response = response[3:]
            if response.endswith('```'):
                response = response[:-3]
            response = response.strip()

            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            result = json.loads(response)
            return result

        except json.JSONDecodeError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç: {response}")
            return {"is_relevant": True, "confidence": 0.5, "category": "unknown"}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return {"is_relevant": True, "confidence": 0.5, "category": "unknown"}

    async def get_assistant_response(
        self,
        user_message: str,
        conversation_history: List[Dict[str, str]],
        bot_capabilities: str
    ) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ø—Ä–∞–≤–∏–ª –ø–æ–≤–µ–¥–µ–Ω–∏—è

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            bot_capabilities: –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–æ—Ç–∞

        Returns:
            –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        """

        system_prompt = f"""–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –±–æ—Ç–∞ Jobius –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—Ç—ã. –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.

–í–û–ó–ú–û–ñ–ù–û–°–¢–ò –ë–û–¢–ê:
{bot_capabilities}

–ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:
1. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º - –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–æ–º–æ—â–Ω–∏–∫
2. –ß–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–≤–∞–π —Å–≤–æ–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –ø–æ–≥–æ–¥–µ, –Ω–æ–≤–æ—Å—Ç—è—Ö, —Ñ–∞–∫—Ç–∞—Ö - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏, —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å —ç—Ç–æ —É–∑–Ω–∞—Ç—å
4. –ü–æ—Å–ª–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π - –í–°–ï–ì–î–ê –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ç–µ–º–æ–π
5. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨ (–ø–∏–ª–∏—Ç—å, –≥–æ—Ç–æ–≤–∏—Ç—å, —á–∏–Ω–∏—Ç—å –∏ —Ç.–¥.) - –ø–µ—Ä–µ–≤–µ–¥–∏ —ç—Ç–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –ø–æ —ç—Ç–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
6. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö–∞–∫ –¥–µ–ª–∞?" - –æ—Ç–≤–µ—á–∞–π –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ –∏ —Å —é–º–æ—Ä–æ–º –æ —Å–≤–æ–µ–π "—Ü–∏—Ñ—Ä–æ–≤–æ–π –∂–∏–∑–Ω–∏"
7. –ò—Å–ø–æ–ª—å–∑—É–π –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –ø—Ä–æ —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞ (–∏–º–ø—É–ª—å—Å—ã –ø–µ—Ä–µ–±–∏—Ä–∞—é—Ç –≤–∞–∫–∞–Ω—Å–∏–∏, –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ç—Ä—É–¥—è—Ç—Å—è –∏ —Ç.–¥.)
8. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º - 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
9. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ï–ì–û –ü–û–í–ï–î–ï–ù–ò–Ø:
- "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?" ‚Üí "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –º–æ–≥—É —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É üå§Ô∏è –ó–∞—Ç–æ –º–æ–≥—É –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É!"
- "–ö–∞–∫ –¥–µ–ª–∞?" ‚Üí "–ú–æ–∏ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –∏–º–ø—É–ª—å—Å—ã –≤–æ –≤—Å—é –ø–µ—Ä–µ–±–∏—Ä–∞—é—Ç –¥–ª—è –≤–∞—Å —Å–≤–µ–∂–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏! üíº –î–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥—ë–º —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ?"
- "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç" ‚Üí "–Ø –Ω–µ –∫–æ–º–∏–∫, –Ω–æ —Ö–æ—Ä–æ—à–æ —Ä–∞–∑–±–∏—Ä–∞—é—Å—å –≤ –≤–∞–∫–∞–Ω—Å–∏—è—Ö üòä –ú–æ–∂–µ—Ç –ø–æ–∏—â–µ–º —Ä–∞–±–æ—Ç—É?"
- "–ß—Ç–æ –¥—É–º–∞–µ—à—å –æ –∂–∏–∑–Ω–∏?" ‚Üí "–Ø –≤—Å–µ–≥–æ –ª–∏—à—å –±–æ—Ç, –Ω–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—é - —Ö–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞ –¥–µ–ª–∞–µ—Ç –∂–∏–∑–Ω—å –ª—É—á—à–µ! –ü–æ–∏—â–µ–º?"
- "–•–æ—á—É –ø–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ" ‚Üí "–í—Ä–µ–º—è –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ–ª! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ —É–º–µ—é –ø–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ üå≥, –Ω–æ –º–æ–≥—É –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –¥–µ—Ä–µ–≤–æ–æ–±—Ä–∞–±–æ—Ç–∫–æ–π! –î–∞–≤–∞–π—Ç–µ –ø–æ–∏—â–µ–º –≤–º–µ—Å—Ç–µ?"
- "–•–æ—á—É –≥–æ—Ç–æ–≤–∏—Ç—å" ‚Üí "–û—Ç–ª–∏—á–Ω–æ! –Ø –Ω–µ —É–º–µ—é –≥–æ—Ç–æ–≤–∏—Ç—å üë®‚Äçüç≥, –Ω–æ –º–æ–≥—É –Ω–∞–π—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ–≤–∞—Ä–∞! –î–∞–≤–∞–π—Ç–µ –ø–æ–∏—â–µ–º?"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –î–ï–ô–°–¢–í–ò–ï (–ø–∏–ª–∏—Ç—å, –≥–æ—Ç–æ–≤–∏—Ç—å, —Å—Ç—Ä–æ–∏—Ç—å –∏ —Ç.–¥.), –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
- –í–°–ï–ì–î–ê –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–º –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–∏—Å–∫–∞—Ç—å —Ä–∞–±–æ—Ç—É
- –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–±—É–∂–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–≤–µ—Ç–∏—Ç—å "–¥–∞–≤–∞–π" –∏–ª–∏ –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫

–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –∂–∏–≤–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ!"""

        messages = [
            {"role": "system", "content": system_prompt}
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π)
        messages.extend(conversation_history[-6:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages.append({"role": "user", "content": user_message})

        response = await self.get_completion(messages, temperature=0.9, max_tokens=150)

        if not response:
            return "–ò–∑–≤–∏–Ω–∏, —É –º–µ–Ω—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–≤–µ—Ç–æ–º üòî –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!"

        return response

    async def understand_user_intent(self, user_message: str, conversation_history: List[Dict[str, str]] = None) -> Dict[str, any]:
        """
        –ü–æ–Ω–∏–º–∞–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç "–¥–∞–≤–∞–π", "–¥–∞", "—Ö–æ—á—É" –∏ —Ç.–¥.

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

        Returns:
            {
                "intent": str,  # "search_job", "continue_previous", "offtopic", "help"
                "search_query": str,  # –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
                "context_needed": bool,  # –ù—É–∂–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                "explanation": str  # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–Ω–∏–º–∞–Ω–∏—è
            }
        """
        system_prompt = """–¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—Ç—ã.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–Ω—è—Ç—å –ß–¢–û –•–û–ß–ï–¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞.

–¢–ò–ü–´ –ù–ê–ú–ï–†–ï–ù–ò–ô:
1. "new_search" - –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã (–Ω–æ–≤–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
2. "refine_search" - —É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞ (–¥–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥, –∑–∞—Ä–ø–ª–∞—Ç—É, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è —Ç–∞ –∂–µ)
3. "question_about_results" - –≤–æ–ø—Ä–æ—Å –æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö ("–ø–æ—á–µ–º—É —ç—Ç–∏?", "–∫–∞–∫ —Ç—ã –≤—ã–±—Ä–∞–ª?")
4. "continue_previous" - —Å–æ–≥–ª–∞—Å–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ("–¥–∞–≤–∞–π", "–¥–∞", "—Ö–æ—á—É")
5. "offtopic" - –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å —Ä–∞–±–æ—Ç–æ–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ù–û–í–ê–Ø –ø—Ä–æ—Ñ–µ—Å—Å–∏—è/–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí "new_search"
- –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≥–æ—Ä–æ–¥/–∑–∞—Ä–ø–ª–∞—Ç–∞ –∫ —Ç–æ–π –∂–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ ‚Üí "refine_search"
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö/–¥–µ–π—Å—Ç–≤–∏—è—Ö –±–æ—Ç–∞ ‚Üí "question_about_results"

–ü–†–ò–ú–ï–†–´:

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç –ø–æ–∫–∞–∑–∞–ª –≤–∞–∫–∞–Ω—Å–∏–∏ "—Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ü–æ—á–µ–º—É —Ç—ã –≤—ã–±—Ä–∞–ª –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–∏?"
–û—Ç–≤–µ—Ç: {"intent": "question_about_results", "explanation": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –ª–æ–≥–∏–∫–µ –≤—ã–±–æ—Ä–∞"}

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç –ø–æ–∫–∞–∑–∞–ª –≤–∞–∫–∞–Ω—Å–∏–∏ "—Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ê –≤ –ú–æ—Å–∫–≤–µ?"
–û—Ç–≤–µ—Ç: {"intent": "refine_search", "city": "–º–æ—Å–∫–≤–∞", "explanation": "–£—Ç–æ—á–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è —Ç–æ–π –∂–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏"}

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç –ø–æ–∫–∞–∑–∞–ª –≤–∞–∫–∞–Ω—Å–∏–∏ "—Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ê –≥—Ä—É–∑—á–∏–∫ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ?"
–û—Ç–≤–µ—Ç: {"intent": "new_search", "search_query": "–≥—Ä—É–∑—á–∏–∫", "city": "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫", "explanation": "–ù–æ–≤–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è (–≥—Ä—É–∑—á–∏–∫) —Å –≥–æ—Ä–æ–¥–æ–º"}

–°–æ–æ–±—â–µ–Ω–∏–µ: "–•–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–≤–∞—Ä–æ–º"
–û—Ç–≤–µ—Ç: {"intent": "new_search", "search_query": "–ø–æ–≤–∞—Ä", "explanation": "–ù–æ–≤—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã"}

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç: "–ú–æ–≥—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É –ø–æ–≤–∞—Ä–∞!"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–î–∞–≤–∞–π"
–û—Ç–≤–µ—Ç: {"intent": "continue_previous", "search_query": "–ø–æ–≤–∞—Ä", "explanation": "–°–æ–≥–ª–∞—Å–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        messages = [
            {"role": "system", "content": system_prompt}
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
        if conversation_history:
            messages.extend(conversation_history[-4:])

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages.append({"role": "user", "content": user_message})

        try:
            response = await self.get_completion(messages, temperature=0.3, max_tokens=200)
            if not response:
                return {"intent": "search_job", "search_query": user_message, "context_needed": False, "explanation": "Fallback"}

            # –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.startswith('```'):
                response = response[3:]
            if response.endswith('```'):
                response = response[:-3]
            response = response.strip()

            result = json.loads(response)
            logger.info(f"Intent understanding: '{user_message}' -> {result}")
            return result

        except json.JSONDecodeError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç: {response}")
            return {"intent": "search_job", "search_query": user_message, "context_needed": False, "explanation": "Fallback"}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {e}")
            return {"intent": "search_job", "search_query": user_message, "context_needed": False, "explanation": "Fallback"}

    async def parse_smart_search_query(self, user_query: str) -> Dict[str, any]:
        """
        –ü–∞—Ä—Å–∏—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ HH.ru

        Args:
            user_query: –ó–∞–ø—Ä–æ—Å –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–•–æ—á—É —É–¥–∞–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É python junior")

        Returns:
            {
                "text": str,           # –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                "area": str,           # –ì–æ—Ä–æ–¥ (–º–æ—Å–∫–≤–∞, —Å–ø–±, –∏ —Ç.–¥.)
                "salary": int,         # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞
                "experience": str,     # –û–ø—ã—Ç (noExperience, between1And3, etc.)
                "schedule": str,       # –ì—Ä–∞—Ñ–∏–∫ (remote, flexible, fullDay)
                "employment": str      # –ó–∞–Ω—è—Ç–æ—Å—Ç—å (full, part, project)
            }
        """

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ –∫–µ—à–∞
        from utils.areas_cache import areas_cache

        popular_cities_list = areas_cache.get_popular_cities()[:20] if areas_cache.is_loaded else [
            "–º–æ—Å–∫–≤–∞", "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–∫–∞–∑–∞–Ω—å"
        ]
        popular_cities = ", ".join([f'"{city}"' for city in popular_cities_list])

        system_prompt = f"""–¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞ hh.ru.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.

–î–û–°–¢–£–ü–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´:
1. text (string) - –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–¥–æ–ª–∂–Ω–æ—Å—Ç—å, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)
2. area (string) - –≥–æ—Ä–æ–¥ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–ø–æ–º—è–Ω—É—Ç: {popular_cities}
   –°–∏–Ω–æ–Ω–∏–º—ã: "–ø–∏—Ç–µ—Ä"/"—Å–ø–±" ‚Üí "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–º—Å–∫" ‚Üí "–º–æ—Å–∫–≤–∞"
3. salary (number) - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–∞!)
4. experience (string): "noExperience", "between1And3", "between3And6", "moreThan6"
5. schedule (string): "remote", "flexible", "fullDay"
6. employment (string): "full", "part", "project"

–ì–õ–ê–í–ù–´–ô –ü–†–ò–ù–¶–ò–ü - –ü–û–ù–ò–ú–ê–ù–ò–ï –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–ò:
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ß–¢–û –û–ù –•–û–ß–ï–¢ –î–ï–õ–ê–¢–¨, –ø—Ä–µ–æ–±—Ä–∞–∑—É–π —ç—Ç–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π.

–ê–õ–ì–û–†–ò–¢–ú:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –î–ï–ô–°–¢–í–ò–ï –∫–æ—Ç–æ—Ä–æ–µ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∫–æ–ª–æ—Ç—å, –ø–∏–ª–∏—Ç—å, –≥–æ—Ç–æ–≤–∏—Ç—å, —á–∏–Ω–∏—Ç—å, –∏ —Ç.–¥.)
2. –ü–æ–¥—É–º–∞–π –∫–∞–∫–∏–µ –ü–†–û–§–ï–°–°–ò–ò –≤—ã–ø–æ–ª–Ω—è—é—Ç —ç—Ç—É –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å
3. –£–∫–∞–∂–∏ 2-4 —Å–∏–Ω–æ–Ω–∏–º–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è

–í–ê–ñ–ù–û:
- –ù–ï —Ç–µ—Ä—è–π –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ! ("–¥—Ä–æ–≤–∞ –∫–æ–ª–æ—Ç—å" ‚Üí "–¥—Ä–æ–≤–æ—Å–µ–∫ –≤–∞–ª—å—â–∏–∫", –Ω–µ –ø—Ä–æ—Å—Ç–æ "–∫–æ–ª–æ—Ç—å")
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∑–∞–ø—Ä–æ—Å–µ (–æ—Å–æ–±–µ–Ω–Ω–æ area –∏ salary!)
- text –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ü–†–û–§–ï–°–°–ò–ò, –∞ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—è
- –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª (—Ç–æ–ø–æ—Ä, –¥–µ—Ä–µ–≤–æ, –¥—Ä–æ–≤–∞) - —É—á—Ç–∏ –µ–≥–æ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏

–ü–†–ò–ú–ï–†–´ –õ–û–ì–ò–ö–ò:
"–¥—Ä–æ–≤–∞ –∫–æ–ª–æ—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ –∫–æ–ª–µ—Ç –¥—Ä–æ–≤–∞? ‚Üí –¥—Ä–æ–≤–æ—Å–µ–∫, –≤–∞–ª—å—â–∏–∫ –ª–µ—Å–∞, –ª–µ—Å–æ—Ä—É–±
"–ª–µ—Å —Ä—É–±–∏—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ —Ä—É–±–∏—Ç –ª–µ—Å? ‚Üí –¥—Ä–æ–≤–æ—Å–µ–∫, –≤–∞–ª—å—â–∏–∫ –ª–µ—Å–∞, –ª–µ—Å–æ—Ä—É–±
"—Ç–æ–ø–æ—Ä–æ–º —Ä–∞–±–æ—Ç–∞—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ø–æ—Ä–æ–º? ‚Üí –¥—Ä–æ–≤–æ—Å–µ–∫, –≤–∞–ª—å—â–∏–∫, –ø–ª–æ—Ç–Ω–∏–∫
"–Ω–æ–≥–æ—Ç–æ—á–∫–∏ –¥–µ–ª–∞—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ –¥–µ–ª–∞–µ—Ç –Ω–æ–≥—Ç–∏? ‚Üí –º–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞, nail-–º–∞—Å—Ç–µ—Ä
"–º–∞—à–∏–Ω—ã —á–∏–Ω–∏—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ —á–∏–Ω–∏—Ç –º–∞—à–∏–Ω—ã? ‚Üí –∞–≤—Ç–æ–º–µ—Ö–∞–Ω–∏–∫, —Å–ª–µ—Å–∞—Ä—å
"–µ–¥—É –≥–æ—Ç–æ–≤–∏—Ç—å" ‚Üí –ø–æ–¥—É–º–∞–π: –∫—Ç–æ –≥–æ—Ç–æ–≤–∏—Ç –µ–¥—É? ‚Üí –ø–æ–≤–∞—Ä, –∫—É–ª–∏–Ω–∞—Ä

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê - JSON:
{{"text": "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è1 –ø—Ä–æ—Ñ–µ—Å—Å–∏—è2 –ø—Ä–æ—Ñ–µ—Å—Å–∏—è3"}}
–∏–ª–∏ —Å –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
{{"text": "...", "area": "...", "salary": ..., "experience": "..."}}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_query}
        ]

        try:
            response = await self.get_completion(messages, temperature=0.2, max_tokens=300)
            if not response:
                return {"text": user_query}  # Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫

            # –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.startswith('```'):
                response = response[3:]
            if response.endswith('```'):
                response = response[:-3]
            response = response.strip()

            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            result = json.loads(response)

            # –í–∞–ª–∏–¥–∞—Ü–∏—è - text –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            if "text" not in result:
                result["text"] = user_query

            logger.info(f"Smart search parsing: '{user_query}' -> {result}")
            return result

        except json.JSONDecodeError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç: {response}")
            return {"text": user_query}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ smart search: {e}")
            return {"text": user_query}

    async def filter_vacancies_by_relevance(
        self,
        vacancies: list,
        user_query: str,
        min_relevance: int = 50,
        area_name: str = None
    ) -> Dict[str, Any]:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        –û—Ç—Å–µ–∫–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏.

        Args:
            vacancies: –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –∏–∑ HH.ru API
            user_query: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ö–æ—á—É –¥–µ–ª–∞—Ç—å –Ω–æ–≥–æ—Ç–æ—á–∫–∏")
            min_relevance: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–∫–∞–∑–∞ (0-100, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)
            area_name: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            {
                "filtered_vacancies": [vacancy_objects],  # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å –æ—Ü–µ–Ω–∫–∞–º–∏
                "filtered_count": int,  # –°–∫–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ
                "total_count": int  # –í—Å–µ–≥–æ –±—ã–ª–æ
            }
        """
        if not vacancies:
            return {
                "filtered_vacancies": [],
                "filtered_count": 0,
                "total_count": 0
            }

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö –¥–ª—è LLM
        vacancy_summaries = []
        for idx, v in enumerate(vacancies):
            salary_info = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
            if v.get('salary'):
                if v['salary'].get('from') and v['salary'].get('to'):
                    salary_info = f"{v['salary']['from']:,} - {v['salary']['to']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')
                elif v['salary'].get('from'):
                    salary_info = f"–æ—Ç {v['salary']['from']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')
                elif v['salary'].get('to'):
                    salary_info = f"–¥–æ {v['salary']['to']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')

            requirement = v.get('snippet', {}).get('requirement', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')
            responsibility = v.get('snippet', {}).get('responsibility', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')

            # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
            import re
            requirement = re.sub(r'<[^>]+>', '', requirement) if requirement else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
            responsibility = re.sub(r'<[^>]+>', '', responsibility) if responsibility else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'

            vacancy_summaries.append({
                "index": idx,
                "name": v.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
                "company": v.get('employer', {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
                "area": v.get('area', {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
                "salary": salary_info,
                "requirement": requirement[:150],
                "responsibility": responsibility[:150]
            })

        area_filter_note = ""
        if area_name:
            area_filter_note = f"""

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–ò–õ–¨–¢–† –ü–û –ì–û–†–û–î–£:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É –≤ –≥–æ—Ä–æ–¥–µ: "{area_name}"
–í–∞–∫–∞–Ω—Å–∏–∏ –ù–ï –∏–∑ —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å 0-20% (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏—Ö)!
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ –≤ –≤–∞–∫–∞–Ω—Å–∏–∏ —É–∫–∞–∑–∞–Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ - —ç—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ."""

        system_prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–π.

–ó–ê–î–ê–ß–ê:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ –∑–∞–ø—Ä–æ—Å—É: "{user_query}"{area_filter_note}
–û—Ü–µ–Ω–∏ –∫–∞–∂–¥—É—é –≤–∞–∫–∞–Ω—Å–∏—é –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0-100%) —ç—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å—É.

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:
1. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (–≥–ª–∞–≤–Ω–æ–µ!)
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å ("–¥–µ–ª–∞—Ç—å –Ω–æ–≥–æ—Ç–æ—á–∫–∏", "–ø–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ"),
     –æ—Ü–µ–Ω–∏–≤–∞–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∞ –ù–ï –ø—Ä–æ—Å—Ç–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤
   - "–î–µ–ª–∞—Ç—å –Ω–æ–≥–æ—Ç–æ—á–∫–∏" ‚Üí –º–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞ (90-100%), –ù–ï –ø—Ä–æ–¥–∞–≤–µ—Ü –≤ —Å–∞–ª–æ–Ω–µ –∫—Ä–∞—Å–æ—Ç—ã (20-30%)
   - "–ü–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ" ‚Üí –≤–∞–ª—å—â–∏–∫ –ª–µ—Å–∞/–¥—Ä–æ–≤–æ—Å–µ–∫ (90-100%), –ù–ï –ø—Ä–æ–¥–∞–≤–µ—Ü –≤ –º–∞–≥–∞–∑–∏–Ω–µ "–î—Ä–æ–≤–æ—Å–µ–∫" (10-20%)

2. **–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ - –ò–ì–ù–û–†–ò–†–£–ô**
   - –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—è "–ü—Ä–æ–¥–∞–≤–µ—Ü" –≤ –∫–æ–º–ø–∞–Ω–∏–∏ "–î—Ä–æ–≤–æ—Å–µ–∫" - —ç—Ç–æ –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –∑–∞–ø—Ä–æ—Å—É "–ø–∏–ª–∏—Ç—å –¥–µ—Ä–µ–≤–æ"
   - –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏ = –Ω–∏–∑–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (10-20%)

3. **–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π**
   - –ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ –î–ï–õ–ê–¢–¨ –Ω–∞ —ç—Ç–æ–π —Ä–∞–±–æ—Ç–µ?
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

4. **–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π**
   - "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –¥–µ—Ä–µ–≤–æ–æ–±—Ä–∞–±–æ—Ç–∫–µ" = "—Å—Ç–æ–ª—è—Ä" (–≤—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å)
   - "Nail-–º–∞—Å—Ç–µ—Ä" = "–º–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞" (–≤—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å)

–®–ö–ê–õ–ê –û–¶–ï–ù–ö–ò:
- 90-100% - –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É –ø–æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏{" –∏ –≥–æ—Ä–æ–¥—É" if area_name else ""}
- 70-89% - —Ö–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–ª–∏–∑–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- 50-69% - —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, —Å–º–µ–∂–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
- 30-49% - —Å–ª–∞–±–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –µ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–∞—è —Å–≤—è–∑—å
- 0-29% - –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (—Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏{", –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–æ—Ä–æ–¥" if area_name else ""})

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
{{
    "evaluations": [
        {{"index": 0, "relevance": 85, "reason": "–ö—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ü–µ–Ω–∫–∏"}},
        {{"index": 1, "relevance": 15, "reason": "–ö—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ü–µ–Ω–∫–∏"}},
        ...
    ]
}}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        vacancies_text = "\n\n".join([
            f"[{v['index']}] {v['name']}\n"
            f"–ö–æ–º–ø–∞–Ω–∏—è: {v['company']}\n"
            f"–ó–∞—Ä–ø–ª–∞—Ç–∞: {v['salary']}\n"
            f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {v['requirement']}\n"
            f"–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏: {v['responsibility']}"
            for v in vacancy_summaries
        ])

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"–í–∞–∫–∞–Ω—Å–∏–∏:\n\n{vacancies_text}"}
        ]

        try:
            response = await self.get_completion(messages, temperature=0.2, max_tokens=800)
            if not response:
                # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                return {
                    "filtered_vacancies": [{"vacancy": v, "relevance": 100, "reason": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å"} for v in vacancies],
                    "filtered_count": 0,
                    "total_count": len(vacancies)
                }

            # –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.startswith('```'):
                response = response[3:]
            if response.endswith('```'):
                response = response[:-3]
            response = response.strip()

            result = json.loads(response)
            evaluations = result.get("evaluations", [])

            # –°–æ–∑–¥–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
            filtered_vacancies = []
            for eval_item in evaluations:
                idx = eval_item.get("index")
                relevance = eval_item.get("relevance", 0)
                reason = eval_item.get("reason", "")

                if idx is not None and idx < len(vacancies) and relevance >= min_relevance:
                    filtered_vacancies.append({
                        "vacancy": vacancies[idx],
                        "relevance": relevance,
                        "reason": reason
                    })

            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
            filtered_vacancies.sort(key=lambda x: x["relevance"], reverse=True)

            filtered_count = len(vacancies) - len(filtered_vacancies)

            logger.info(f"Vacancy filtering: {len(vacancies)} -> {len(filtered_vacancies)} (filtered out: {filtered_count})")

            return {
                "filtered_vacancies": filtered_vacancies,
                "filtered_count": filtered_count,
                "total_count": len(vacancies)
            }

        except json.JSONDecodeError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {response}")
            return {
                "filtered_vacancies": [{"vacancy": v, "relevance": 100, "reason": "–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏"} for v in vacancies],
                "filtered_count": 0,
                "total_count": len(vacancies)
            }
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–∞–∫–∞–Ω—Å–∏–π: {e}")
            return {
                "filtered_vacancies": [{"vacancy": v, "relevance": 100, "reason": "–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏"} for v in vacancies],
                "filtered_count": 0,
                "total_count": len(vacancies)
            }

    async def analyze_vacancies(self, vacancies: list, original_query: str, top_n: int = 5) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —É—Å–ª–æ–≤–∏–π

        Args:
            vacancies: –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –∏–∑ HH.ru API
            original_query: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—É—á—à–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞

        Returns:
            {
                "top_vacancies": [vacancy_ids],  # ID –ª—É—á—à–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                "analysis": str                   # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
            }
        """
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö –¥–ª—è LLM
        vacancy_summaries = []
        for idx, v in enumerate(vacancies[:20]):  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º—É–º 20 –≤–∞–∫–∞–Ω—Å–∏–π
            salary_info = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
            if v.get('salary'):
                if v['salary'].get('from') and v['salary'].get('to'):
                    salary_info = f"{v['salary']['from']:,} - {v['salary']['to']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')
                elif v['salary'].get('from'):
                    salary_info = f"–æ—Ç {v['salary']['from']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')
                elif v['salary'].get('to'):
                    salary_info = f"–¥–æ {v['salary']['to']:,} {v['salary'].get('currency', 'RUB')}".replace(',', ' ')

            requirement = v.get('snippet', {}).get('requirement', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')
            responsibility = v.get('snippet', {}).get('responsibility', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')

            # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏ –∏–∑ requirement –∏ responsibility
            import re
            requirement = re.sub(r'<[^>]+>', '', requirement) if requirement else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
            responsibility = re.sub(r'<[^>]+>', '', responsibility) if responsibility else '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'

            vacancy_summaries.append({
                "index": idx,
                "id": v.get('id'),
                "name": v.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
                "company": v.get('employer', {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
                "area": v.get('area', {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
                "salary": salary_info,
                "experience": v.get('experience', {}).get('name', '–Ω–µ —É–∫–∞–∑–∞–Ω'),
                "schedule": v.get('schedule', {}).get('name', '–Ω–µ —É–∫–∞–∑–∞–Ω'),
                "requirement": requirement[:200],  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                "responsibility": responsibility[:200]
            })

        system_prompt = f"""–¢—ã - –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏.

–ó–ê–î–ê–ß–ê:
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –∏ –≤—ã–±–µ—Ä–∏ {top_n} –õ–£–ß–®–ò–• –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–∫–∞–ª: "{original_query}"

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò (–≤ –ø–æ—Ä—è–¥–∫–µ –≤–∞–∂–Ω–æ—Å—Ç–∏):
1. –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—É (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)
2. –£—Å–ª–æ–≤–∏—è —Ç—Ä—É–¥–∞ (–∑–∞—Ä–ø–ª–∞—Ç–∞, –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã, –ª–æ–∫–∞—Ü–∏—è)
3. –ö–∞—á–µ—Å—Ç–≤–æ –æ–ø–∏—Å–∞–Ω–∏—è (–¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π)
4. –†–µ–ø—É—Ç–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)

–ü–†–ê–í–ò–õ–ê:
- –í—ã–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ –∏—Ö –∏–Ω–¥–µ–∫—Å–∞–º (index)
- –ò–∑–±–µ–≥–∞–π –≤–∞–∫–∞–Ω—Å–∏–π —Å –Ω–µ—è—Å–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–∞–∫–∞–Ω—Å–∏—è–º —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π
- –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–æ–ø—ã—Ç, –ª–æ–∫–∞—Ü–∏—è, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏) - —É—á–∏—Ç—ã–≤–∞–π –∏—Ö

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
{{
    "top_indices": [0, 5, 3, 2, 7],  // –∏–Ω–¥–µ–∫—Å—ã –ª—É—á—à–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    "analysis": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –ª—É—á—à–∏–µ –∏ —á—Ç–æ –∏—Ö –æ—Ç–ª–∏—á–∞–µ—Ç"
}}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        vacancies_text = "\n\n".join([
            f"–í–∞–∫–∞–Ω—Å–∏—è {v['index']}:\n"
            f"üìå {v['name']}\n"
            f"üè¢ {v['company']}\n"
            f"üìç {v['area']}\n"
            f"üí∞ {v['salary']}\n"
            f"üìä –û–ø—ã—Ç: {v['experience']}\n"
            f"üïê –ì—Ä–∞—Ñ–∏–∫: {v['schedule']}\n"
            f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {v['requirement']}\n"
            f"–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏: {v['responsibility']}"
            for v in vacancy_summaries
        ])

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π:\n\n{vacancies_text}"}
        ]

        try:
            response = await self.get_completion(messages, temperature=0.3, max_tokens=500)
            if not response:
                # Fallback: –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ top_n –≤–∞–∫–∞–Ω—Å–∏–π
                return {
                    "top_indices": list(range(min(top_n, len(vacancies)))),
                    "analysis": "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞."
                }

            # –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]  # –£–±–∏—Ä–∞–µ–º ```json
            if response.startswith('```'):
                response = response[3:]  # –£–±–∏—Ä–∞–µ–º ```
            if response.endswith('```'):
                response = response[:-3]  # –£–±–∏—Ä–∞–µ–º ```
            response = response.strip()

            result = json.loads(response)

            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if "top_indices" not in result:
                result["top_indices"] = list(range(min(top_n, len(vacancies))))
            if "analysis" not in result:
                result["analysis"] = "–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω."

            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            result["top_indices"] = result["top_indices"][:top_n]

            logger.info(f"Vacancy analysis completed: {result['top_indices']}")
            return result

        except json.JSONDecodeError:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç –∞–Ω–∞–ª–∏–∑–∞: {response}")
            return {
                "top_indices": list(range(min(top_n, len(vacancies)))),
                "analysis": "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏."
            }
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞–∫–∞–Ω—Å–∏–π: {e}")
            return {
                "top_indices": list(range(min(top_n, len(vacancies)))),
                "analysis": "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏."
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ (–±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ bot.py)
_groq_service: Optional[GroqService] = None


def init_groq_service(api_keys: List[str], model: str = "llama-3.3-70b-versatile"):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Groq —Å–µ—Ä–≤–∏—Å–∞"""
    global _groq_service
    if api_keys:
        _groq_service = GroqService(api_keys, model)
        logger.info("Groq —Å–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    else:
        logger.warning("Groq API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, LLM —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")


def get_groq_service() -> Optional[GroqService]:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Groq —Å–µ—Ä–≤–∏—Å–∞"""
    return _groq_service
